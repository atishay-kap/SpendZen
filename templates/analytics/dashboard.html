{% extends "base.html" %}
{% block content %}
<div class="max-w-5xl mx-auto p-6 space-y-6">
  <h1 class="text-2xl font-semibold">Dashboard</h1>

  <!-- Summary Card -->
  <div id="summaryCard" class="p-4 rounded-xl border bg-gray-50 text-center text-lg font-medium"></div>

  <div class="grid md:grid-cols-2 gap-6">
    <!-- Category Chart -->
    <div class="p-4 rounded-xl border">
      <h2 class="font-medium mb-2">Expenses by Category</h2>
      <canvas id="catChart"></canvas>
    </div>

    <!-- Monthly Totals -->
    <div class="p-4 rounded-xl border">
      <h2 class="font-medium mb-2">Expenses by Month</h2>
      <canvas id="monthChart"></canvas>
    </div>
  </div>

  <!-- Daily Cumulative -->
  <div class="p-4 rounded-xl border">
    <h2 class="font-medium mb-2">Daily Cumulative (Current Month)</h2>
    <canvas id="dailyChart"></canvas>
  </div>

  <!-- Budgets Progress -->
  <div class="p-4 rounded-xl border">
    <h2 class="font-medium mb-4">Budgets (This Month)</h2>
    <div id="budgetsContainer" class="space-y-4"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Helper: Tailwind-ish colors
const chartColors = ["#3b82f6", "#10b981", "#f59e0b", "#ef4444", "#8b5cf6"];

// Category chart
fetch("{% url 'expenses_by_category' %}")
  .then(res => res.json())
  .then(data => {
    const labels = data.map(x => x.category__name || "Uncategorized");
    const values = data.map(x => x.total);
    new Chart(document.getElementById("catChart"), {
      type: "doughnut",
      data: { 
        labels, 
        datasets: [{
          label: "Expenses by Category",
          data: values,
          backgroundColor: chartColors
        }] 
      }
    });
  });

// Monthly totals (bar chart)
fetch("{% url 'expenses_by_month' %}")
  .then(res => res.json())
  .then(data => {
    const labels = data.map(x => new Date(x.month).toLocaleDateString("en-US", { month: "short", year: "numeric" }));
    const values = data.map(x => x.total);
    new Chart(document.getElementById("monthChart"), {
      type: "bar",
      data: { 
        labels, 
        datasets: [{
          label: "Monthly Total",
          data: values,
          backgroundColor: chartColors
        }] 
      },
      options: {
        scales: {
          x: { title: { display: true, text: "Month" } },
          y: { title: { display: true, text: "Amount" } }
        }
      }
    });
  });

// Daily cumulative (line chart)
fetch("{% url 'daily_cumulative_expenses' %}")
  .then(res => res.json())
  .then(data => {
    const labels = data.map(x => new Date(x.day).toLocaleDateString("en-US", { month: "short", day: "numeric" }));
    const values = data.map(x => x.total);
    new Chart(document.getElementById("dailyChart"), {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: "Cumulative Spending",
          data: values,
          fill: true,
          borderColor: "#3b82f6",
          backgroundColor: "rgba(59,130,246,0.2)",
          tension: 0.2
        }]
      },
      options: {
        scales: {
          x: { title: { display: true, text: "Day" } },
          y: { title: { display: true, text: "Amount" } }
        }
      }
    });
  });

// Fetch and render budgets
fetch("{% url 'budgets:current_month_budgets' %}")
  .then(res => res.json())
  .then(data => {
    const container = document.getElementById("budgetsContainer");
    const summary = document.getElementById("summaryCard");

    if (data.length === 0) {
      container.innerHTML = "<p class='text-gray-500'>No budgets set for this month.</p>";
      summary.innerHTML = "<p class='text-gray-500'>No data to summarize.</p>";
      return;
    }

    let totalPlanned = 0, totalSpent = 0;
    container.innerHTML = ""; // reset container
    data.forEach((b, idx) => {
      totalPlanned += parseFloat(b.amount);
      totalSpent += parseFloat(b.spent);

      const percent = b.amount > 0 ? Math.min((b.spent / b.amount) * 100, 100) : 0;
      const color = b.overspent ? "bg-red-500" : percent > 80 ? "bg-yellow-500" : "bg-green-500";

      container.innerHTML += `
        <div>
          <div class="flex justify-between mb-1 text-sm">
            <span>Budget ${idx + 1} (${b.month_display} ${b.year})</span>
            <span>Spent: â‚¹${b.spent.toFixed(2)} / Planned: â‚¹${b.amount.toFixed(2)} | Remaining: â‚¹${b.remaining.toFixed(2)}</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-4">
            <div class="h-4 rounded-full ${color}" style="width: ${percent}%;"></div>
          </div>
          ${b.overspent ? "<p class='text-red-600 text-xs mt-1'>Overspent!</p>" : ""}
        </div>
      `;
    });

    // update summary card with status
    const remaining = totalPlanned - totalSpent;
    const percentSpent = totalPlanned > 0 ? (totalSpent / totalPlanned) * 100 : 0;

    let status = "ðŸŸ¢ On Track";
    if (totalSpent > totalPlanned) {
      status = "ðŸ”´ Overspent";
    } else if (percentSpent >= 80) {
      status = "ðŸŸ¡ Nearing Limit";
    }

    summary.innerHTML = `
      <p>Total Planned: â‚¹${totalPlanned.toFixed(2)} | Total Spent: â‚¹${totalSpent.toFixed(2)} | Remaining: â‚¹${remaining.toFixed(2)}</p>
      <p class="mt-2">Status: <span class="font-semibold">${status}</span></p>
    `;
  });
</script>
{% endblock %}
